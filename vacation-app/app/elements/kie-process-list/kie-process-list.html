<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="kie-process-list">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <kie-execution-server
      id="kieServer"
      op="[[getProcessUrl]]"
      username="[[user.userId]]"
      password="[[user.password]]"
      response="{{processList}}">
    </kie-execution-server>

    <kie-execution-server
      id="kieServer"
      op="[[getProcessUrl]]"
      username="[[user.userId]]"
      password="[[user.password]]"
      response="{{processList}}">
    </kie-execution-server>

    <iron-list items="[[processData]]" as="item">
      <template>
      <div class="flex vertical layout">
      <div class="flex horizontal layout">
        <paper-input type="datetime-local" label="Requested in" value="{{_toDate(item)}}" readonly></paper-input>
        <paper-input label="Process Instance Id" value="{{item.process-instance-id}}" readonly></paper-input>
        <paper-input label="Description" value="{{item.variables.description}}" readonly></paper-input>
      </div>
    </div>
      </template>
    </iron-list>

  </template>

  <script>
    (function () {
      Polymer({
        is: 'kie-process-list',
        properties: {
          processId: {
            type: String
          },
          getProcessUrl: {
            type: String
          },
          getProcessVariablesUrl: {
            type: String
          },
          user: {
            type: Object
          },
          initiator: {
            type: String
          },
          columns: {
            type: Array
          },
          page: {
            type: Number,
            value: 0
          },
          pageSize: {
            type: Number,
            value: 10
          },
          processList: {
            type: Object,
            observer: "_setUpData"
          },
          processData: {
            type: Array
          }
        },

        ready: function() {
          this._refresh();
        },

        _toDate: function(processInstance) {
          console.log(processInstance["start-date"]);
          return new Date(processInstance["start-date"]).toISOString().slice(0, 16);;
        },

        _refresh: function() {
          this.getProcessUrl = "queries/processes/" + this.processId +"/instances?page=" + this.page + "&pageSize=" + this.pageSize;
          if (this.initiator != null) {
            this.getProcessUrl += "&initiator=" + this.initiator;
          }
          console.log(this.getProcessUrl);
          this.$.kieServer.execute();
        },

        _setUpData: function() {
          if (this.columns == null) {
            this.processData = this.processList["process-instance"];
          } else {
            // TODO filter
          }
          // TODO: request process variables and put them into processData
          /**for () {
            this.getProcessVariablesUrl = "queries/processes/instances/" + PROCESS_INST_ID + "/variables/instances";
          }*/
        }

      });
    })();
  </script>

</dom-module>
